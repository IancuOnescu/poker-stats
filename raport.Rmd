---
title: "Raport"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**TODO:** Chestia asta o sa trebuiasca scrisa cat de cat formal banuiesc

## Procesare dataset
Dataset-ul initial contine 10 milioane de maini din jocuri de poker in format text. Pentru convenienta am transformat toate fisierele in format `feather` aplicand urmatorii pasi:

* `decompress.py` contine codul pentru dezarhivarea fisierelor
* `parse.py` contine codul pentru transformarea din text in CSV
* Creem structura directorului de iesire
```bash
find parsed_data -type d > dirs.txt
sed -i 's/parsed_data/dataframes/g' dirs.txt
xargs mkdir -p < dirs.txt
rm -f dirs.txt
```
* Pentru transformarea din CSV in Feather am utilizat urmatorul cod R din pachetul nostru `PokerStats`:
```{r eval=FALSE}
library(PokerStats)
convert_all_csvs_to_feather("./parsed_data")
```

* Creem un singur fisier doar pentru castiguri pentru a evita procesari multiple inutile:
```{r eval=FALSE}
library(PokerStats)
library(feather)
library(tictoc)

tic("Compile all datasets into one")
pdbs = load_pdbs("./dataframes")
data = rbindlist(pdbs)
write_feather(data, "./dataframes/all_hands.feather")
toc()

rm(pdbs)
rm(data)
gc()
```

## Repartitie castiguri (draft)

```{r eval=TRUE, cache=TRUE}
library(PokerStats)
library(feather)
library(tictoc)
library(dplyr)

data = read_feather("./dataframes/all_hands.feather")
plist = players_list(data)
pfreq = player_hands_freq(data)
pstat = player_hands_stats(pfreq)

fpfreq = filter(pfreq, hands >= 10000)

#pdata = filter(data, p_name == "lurker")
#plot_bankroll(pdata)

for (i in sample(1:length(fpfreq$p_name), 15)) {
  tic(sprintf("Evaluate player %d", i))
  pdata = filter(data, p_name == fpfreq$p_name[i])
  plot_player_distr(pdata, as.character(fpfreq$p_name[i]), 10000,
                    prefiltered = TRUE)
  plot_bankroll(pdata, as.character(pfreq$p_name[i]))
  toc()
}
```

## Legea lui Benford

```{r eval=FALSE}
library(benford.analysis)
library(tictoc)

var_name = list()
digits = list()
filename = list()

j = 1
for (i in 1:3) {
  tic(paste("Benford pot size - digits", i))
  bf1 = benford(factor_to_int(data$p_pot_sz), number.of.digits = i)
  bf1$data = NULL
  fname = paste("pot_size_", j, ".rds", sep = "")
  saveRDS(bf1, file = fname)
  gc()
  toc()
  var_name = append(var_name, "pot_size")
  digits = append(digits, i)
  filename = append(filename, fname)
  j=j+1
  
  tic(paste("Benford bankroll - digits", i))
  bf2 = benford(factor_to_int(data$p_bankroll), number.of.digits = i)
  bf2$data = NULL
  fname = paste("bankroll_", j, ".rds", sep = "")
  saveRDS(bf2, file = fname)
  gc()
  toc()
  var_name = append(var_name, "bankroll")
  digits = append(digits, i)
  filename = append(filename, fname)
  j=j+1
  
  tic(paste("Benford win - digits", i))
  bf3 = benford(factor_to_int(data$win), number.of.digits = i)
  bf3$data = NULL
  fname = paste("win_", j, ".rds", sep = "")
  saveRDS(bf3, file = fname)
  gc()
  toc()
  var_name = append(var_name, "win_")
  digits = append(digits, i)
  filename = append(filename, fname)
  j=j+1
}
dfbf = data.frame(unlist(var_name), unlist(digits), unlist(filename))
colnames(dfbf) = c("var_name", "digits", "filename")
write_feather(dfbf, "benford_index.feather")
```
